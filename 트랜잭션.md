트랜잭션(Transaction)
=====================

## 트랜젝션이란?

트랜젝션은 데이터베이스의 상태를 변화시키기 위한 **작업 수행의 논리적 단위**를 의미한다.

우리는 데이터베이스로 SQL 쿼리를 보냄으로써 데이터베이스의 **상태**를 변화시킨다. 그렇다면 **작업 단위**라는 것은 무엇을 말하는 것일까? **작업 단위**는 사용자가 특정 기능의 수행을 위해 SQL 작업을 묶은 단위를 의미한다.

>ex ) 송금 서비스를 예로 들어보자. 송금 서비스는 **1. A가 돈을 보내고, 2. B가 그 돈을 안전하게 받았을때** 완전히 실행이 됐다고 할 수 있다. 두 과정이 다른 트랜젝션, 즉 다른 작업으로 분리되었다고 생각해보자.<br/><br/>
>A가 돈을 10000원 송금하면 A의 돈 데이터에서 10000원이 차감될 것이다. 그에 맞춰서 B의 잔고는 10000원이 추가 될 것이다. 만약 A의 로직에서 오류가 발생해 트랜젝션 rollback이 일어난다면 A의 돈 데이터는 다시 10000원이 추가됨으로써 원상복구가 될 것이다. 그치만 B의 돈은 어떠한가? 다른 트랜젝션으로 분류되었기에 아무런 rollback도 일어나지 않기 때문에 **돈이 추가된 상태로 남게 된다.**<br/><br/>
>송금 과정을 하나의 작업 단위로 묶지 않으면 당사자들간의 데이터 불일치가 나타날 수 있다. 우리는 두 과정을 **하나의 트랜젝션**으로 묶어야 한다. 그래야 중간에 문제가 발생해도 두 과정 모두 rollback이 일어날 수 있다.

이처럼 작업 단위를 잘 설정하는 것은 서비스를 구성함에 있어서 매우 중요한 부분이다. 트랜젝션이 성공적으로 마무리 되었다면 **commit**을 호출해서 수정 사항을 DB에 영구적으로 반영하고, 중간에 오류가 발생했다면 **rollback**을 호출해서 트랜젝션 내부의 모든 작업을 원상복구 시킨다.

**DBMS의 성능은 초당 트랜잭션의 실행 수**( **TPS** : Transaction per second )로 측정한다.<br/><br/><br/><br/>
## 트랜젝션의 특성 (ACID)

트랜젝션은 ACID라는 4가지의 특성을 만족해야 한다.

### 원자성(Automicity)

트랜젝션 내부에서 실행된 작업들은 모두 성공해서 commit이 되거나, 문제가 발생한다면 rollback을 통해 모두 취소되야 한다. 즉 작업 중 일부분만 성공 할 수 없다. 위의 송금서비스의 예시가 원자성에 대한 설명이다.

- **원자성 보장**

트랜젝션 내에서 데이터베이스를 수정할때 지금까지의 성공적인 상태가 롤백 이미지로 롤백 세그먼트라는 임시 영역에 저장 된다. 만약 문제가 생겨서 롤백이 일어난다면 롤백 세그먼트 내의 상태가 복구된다. 참고로 트랜젝션을 commit한 후에는 DB에 수정사항이 영구적으로 반영되기 때문에 롤백 세그먼트의 롤백 이미지도 날라간다.

만약 긴 트랜젝션 범위 내에서 대부분의 로직이 성공적으로 수행됐는데 마지막에 문제가 생겨서 롤백이 된다고 생각해보자. 문제가 발생하지 않은 영역까지 반복적으로 수행해야 하는건 손해이기 때문에 성공적인 지점 까지는 **savePoint**를 설정할 수 있다.

### [savePoint](https://devjem.tistory.com/27#savePoint)

savePoint는 트랜젝션 내부에서 사용자가 지정할 수 있는 세부 작업 단위라고 생각할 수 있다. 아래의 그림처럼 특정 지점에 savePoint를 설정 한 후 'Rollback to savePoint1' 을 통해 해당 지점으로 롤백을 할 수 있다.

기억해야할 점은 아래 그림에서 SP1으로 롤백을 한 뒤에는 미래 시점인 SP2의 savePoint는 삭제 된다는 것이다.
