## DB 파티셔닝

### 배경

* 서비스의 크기가 점점 커지고 DB에 저장하는 데이터의 규모 또한 대용량화 되면서, 기존에 사용하는 DB 시스템의 용량(storage)의 한계와 성능(performance)의 저하 를 가져오게 되었다.

* 즉, VLDB(Very Large DBMS)와 같이 하나의 DBMS에 너무 큰 table이 들어가면서 용량과 성능 측면에서 많은 이슈가 발생하게 되었고, 이런 이슈를 해결하기 위한 방법으로 table을 ‘파티션(partition)’이라는 작은 단위로 나누어 관리하는 ‘파티셔닝(Partitioning)’기법 이 나타나게 되었다.

* 파티션 테이블은 논리적으로는 하나의 테이블이지만 물리적으로는 여러 개의 파티션으로 나뉘어 데이터들이 각각의 세그먼트에 저장되는 테이블이다. 파티션 테이블에는 Pruning이라는 기능이 있어서 특정 데이터를 조회를 할 때 그 데이터가 속해있는 세그먼트만 빠르게 조회할 수 있는 기능이 있다. 이 뿐만이 아니라 파티션 테이블은 논리적으로는 하나의 테이블이기 때문에 조회 쿼리문을 특별하게 지정해 줄 필요는 없지만 데이터들이 물리적으로 다른 세그먼트에 저장되기 때문에 개발과 관리 양쪽 측면에서 장점이 많다.

### 개념

* 논리적인 데이터 element들을 다수의 entity로 쪼개는 행위를 뜻하는 일반적인 용어

* 즉 큰 table이나 index를, 관리하기 쉬운 partition이라는 작은 단위로 물리적으로 분할하는 것을 의미한다.

* 물리적인 데이터 분할이 있더라도, DB에 접근하는 application의 입장에서는 이를 인식하지 못한다.


### 목적

1. 성능(Performance)
    * 특정 DML과 Query의 성능을 향상시킨다.
    * 주로 대용량 Data WRITE 환경에서 효율적이다.
    * 특히, Full Scan에서 데이터 Access의 범위를 줄여 성능 향상을 가져온다.
    * 많은 INSERT가 있는 OLTP 시스템에서 INSERT 작업을 작은 단위인 partition들로 분산시켜 경합을 줄인다.
    
2. 가용성(Availability)
    * 물리적인 파티셔닝으로 인해 전체 데이터의 훼손 가능성이 줄어들고 데이터 가용성이 향상된다.
    * 각 분할 영역(partition별로)을 독립적으로 백업하고 복구할 수 있다.
    * table의 partition 단위로 Disk I/O을 분산하여 경합을 줄이기 때문에 UPDATE 성능을 향상시킨다.

3. 관리용이성(Manageability)
    * 큰 table들을 제거하여 관리를 쉽게 해준다.

### DB 파티셔닝(Partitioning)의 장단점
    
    장점
     * 관리적 측면 : partition 단위 백업, 추가, 삭제, 변경
        - 전체 데이터를 손실할 가능성이 줄어들어 데이터 가용성이 향상된다. (디스크 장애 시 해당 파티션만 영향을 받으므로 데이터의 훼손 가능성이 감소하고 가용성이 향상)
        - partition별로 백업 및 복구가 가능하다.
        - partition 단위로 I/O 분산이 가능하여 UPDATE 성능을 향상시킨다.
     * 성능적 측면 : partition 단위 조회 및 DML수행
        - 데이터 전체 검색 시 필요한 부분만 탐색해 성능이 증가한다.
        - 즉, Full Scan에서 데이터 Access의 범위를 줄여 성능 향상을 가져온다.
        - 필요한 데이터만 빠르게 조회할 수 있기 때문에 쿼리 자체가 가볍다.
    단점
        - table간 JOIN에 대한 비용이 증가한다.
        - table과 index를 별도로 파티셔닝할 수 없다.
        - table과 index를 같이 파티셔닝해야 한다.

### 파티셔닝의 종류

 ![horizontal-partitioning](https://user-images.githubusercontent.com/42952074/216967243-0839e2f7-709f-483d-99cb-5a4ad46f34d0.png)

    1. 수평 파티셔닝 (Horizontal Partitioning)
    수평 파티셔닝은 하나의 테이블의 각 행을 다른 테이블에 분산시키는 것이다. 
    
    예를 들어 [그림 1]과 같이 5개의 행이 있는 테이블을 각각 3개, 2개의 행을 가진 테이블로 쪼갤 수 있다.
  
    장점

    데이터의 개수를 기준으로 나누어 파티셔닝한다.
    데이터의 개수와 인덱스의 개수가 줄어들어 성능이 향상된다.

    단점

    데이터를 찾는 과정이 기존보다 복잡하므로 Latency가 증가한다.
    
  ![vertical-partitioning](https://user-images.githubusercontent.com/42952074/216967258-5a1583cd-5e1c-4dde-8ea1-c4ee96bd39a0.png)
    
    2. 수직 파티셔닝 (Vertical Partitioning)
    수직 파티셔닝은 테이블의 일부 열을 빼내는 형태로 분할한다. 즉, 테이블의 칼럼을 기준으로 나누어 파티셔닝 한다.
    정규화도 수직 파티셔닝과 관련된 과정이라고 할 수 있다. 하지만 수직 파티셔닝은 이미 정규화된 데이터를 분리하는 과정이라고 생각해야 한다.

    장점

    자주 사용하는 칼럼을 분리하여 성능을 향상할 수 있다.
    같은 타입의 데이터가 저장되어 데이터 압축률을 높일 수 있다.
    조회 시 필요 없는 칼럼을 조회하지 않아도 되므로 성능상의 이점이 있다.

    단점 

    데이터를 찾는 과정이 기존보다 복잡하므로 Latency가 증가한다.
    
### 파티셔닝 범위

![partitioning](https://user-images.githubusercontent.com/42952074/216968090-a8b23b2f-a6b5-4557-8c8d-c4f1ddcff5ec.png)

    1. 범위 분할 (range partitioning)
      - 연속적인 숫자나 날짜를 기준으로 파티셔닝 한다.
      - 분할 키 값이 범위 내에 있는지 여부로 구분한다.
      - 우편 번호, 날짜 등의 데이터에 적합하다.
      - 범위가 포함하는 데이터의 양이 일정하지 않은 경우 특정 파티션에 대해 데이터가 편중될 수 있음
 
    2. 목록 분할 (list partitioning)
      - 파티션 컬럼을 명시, 키 컬럼 값을 기준으로 파티션 하는 방식 / 컬럼의 구체적인 값들에 대해 파티션을 명확하게 컨트롤하고자 할 때 효율적
      - 특정 파티션에 저장될 데이터에 대한 명시적 제어가 가능하다. (명시되지 않은 값을 가진 Row는 Insert가 불가능)
      - 분포도가 비슷하며, 많은 SQL에서 해당 칼럼의 조건이 많이 들어오는 경우 유용하다.
 
    3. 해시 분할 (hash partitioning)
      - 파티션 키(Key)의 해시 값에 의한 파티셔닝이 이루어진다.
      - 균등한 데이터 분할이 가능하다.
      - 특정 데이터가 어느 Hash 파티션에 있는지 판단하기 어렵다.
      - 해시 함수의 값에 따라 파티션에 포함할지 여부를 결정한다.
      - 파티션을 위한 범위가 없는 데이터에 적합하다.
 
    4. 합성 분할 (composite partitioning)
      - 상기 기술을 결합하는 것을 의미한다. 즉, 파티션의 sub-partitioning을 뜻한다.
      - 큰 파티션에 대한 I/O 요청을 여러 파티션으로 분산할 수 있다.
      - 예를 들면 먼저 범위 분할하고, 다음에 해시 분할 같은 것을 생각할 수 있다. 
      
 ### (참고) 샤딩(Sharding)이란?

샤딩은 같은 테이블 스키마를 가진 데이터를 다수의 데이터베이스에 분산하여 저장하는 기법을 뜻한다. 

종종 샤딩과 수평 파티셔닝이 같은 의미로 사용되곤 하지만, 사실 둘은 조금 다르다. 

수평 파티셔닝은 같은 데이터베이스 내에서 하나의 큰 테이블을 쪼개 분산 저장하는 기법이다.

반면, 샤딩은 하나의 큰 테이블을 쪼개 각각 다른 데이터베이스에 분산 저장하는 기법이다.

이러한 샤딩은 수평 파티셔닝의 장점을 모두 갖는다. 

샤딩은 데이터베이스 서버 간의 연결 과정이 많아져 비용이 증가할 수 있다. 또한 하나의 서버가 고장 나면 데이터의 무결성이 깨질 수 있다는 단점도 있다.
